- name: "{{ item }} / create directories"
  file:
    state: directory
    path: "{{ dir }}"
  loop:
    - "{{ dockers_dir }}/{{ item }}"
    - "{{ dockers_dir }}/promtail"
  loop_control:
    loop_var: dir

- name: "{{ item }} / deploy grafana"
  docker_container:
    state: started
    name: "{{ item }}"
    image: grafana/grafana-oss
    restart_policy: unless-stopped
    networks: 
      - name: traefik
    user: "0"
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - "{{ dockers_dir }}/{{ item }}:/var/lib/grafana"
    labels:
      traefik.enable: "true"

      homepage.group: "services"
      homepage.name: "{{ item }}"
      homepage.icon: "{{ item }}"
      homepage.href: "http://{{ item }}.{{ inventory_hostname }}"

- name: "{{ item }} / deploy loki"
  docker_container:
    state: started
    name: "{{ item }}-loki"
    image: grafana/loki:latest
    restart_policy: unless-stopped
    networks: 
      - name: traefik
    user: "0"
    command: -config.file=/etc/loki/local-config.yaml
    labels:
      traefik.enable: "true"

- name: "{{ item }} / add config"
  register: promtail_config
  copy:
    dest: "{{ dockers_dir }}/promtail/promtail.yml"
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      clients:
        - url: http://grafana-loki:3100/loki/api/v1/push

      positions:
        filename: /tmp/positions.yaml

      scrape_configs:

        - job_name: systemd-journal
          journal:
            json: false
            max_age: 12h
            path: /var/log/journal
            labels:
              job: systemd-journal
          relabel_configs:
            - action: drop
              source_labels: ["__journal__transport"]
              regex: "kernel"
            - source_labels: ["__journal__systemd_unit"]
              target_label: "unit"
            - source_labels: ["__journal__hostname"]
              target_label: "host_name"
            - source_labels: ["__journal__transport"]
              target_label: "transport"
            - source_labels: ["__journal__cmdline"]
              target_label: "_cmdline"
            - source_labels: ["__journal_priority"]
              target_label: "_priority"
            - source_labels: ["__journal_priority_keyword"]
              target_label: "priority"
            - source_labels: ["__journal_syslog_identifier"]
              target_label: "syslog_identifier"
            - source_labels: ["__journal_syslog_message_severity"]
              target_label: "level"
            - source_labels: ["__journal_syslog_message_facility"]
              target_label: "syslog_facility"


- name: "{{ item }} / deploy promtail"
  docker_container:
    state: started
    name: "{{ item }}-promtail"
    image: grafana/promtail:latest
    restart_policy: unless-stopped
    restart: "{{ promtail_config.changed | default(false) }}"
    networks: 
      - name: traefik
    user: "0"
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - /var/log/journal:/var/log/journal:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers:ro

      - "{{ dockers_dir }}/promtail/promtail.yml:/etc/promtail/promtail.yml"
    command: -config.file=/etc/promtail/promtail.yml